# 文件上传漏洞

## 漏洞概述

​    文件上传漏洞是指用户上传了可执行的脚本文件,并通过此脚本文件获得了执行服务器
端命令的能力。这种攻击方式是最为直接和有效的，有时候几乎没有什么技术门槛（无验证
上传漏洞）。

## 漏洞成因

漏洞源码示例：

```php
<?php
	if (isset($_POST['Upload'])) {

			$target_path = DVWA_WEB_PAGE_TO_ROOT."hackable/uploads/";
			$target_path = $target_path . basename( $_FILES['uploaded']['name']);

			if(!move_uploaded_file($_FILES['uploaded']['tmp_name'], $target_path)) {
				
				$html .= '<pre>';
				$html .= 'Your image was not uploaded.';
				$html .= '</pre>';
				
      		} else {
			
				$html .= '<pre>';
				$html .= $target_path . ' succesfully uploaded!';
				$html .= '</pre>';
				
			}

		}
?>
```

导致文件上传的漏洞的原因较多，主要包括以下几类：

- 服务器配置不当
- 开源编辑器上传漏洞
- 本地文件上传限制被绕过
-  过滤不严或被绕过
- 文件解析漏洞导致文件执行
- 文件路径截断

## 常见漏洞类型

- 基于无验证的上传漏洞
- 基于 js 验证的上传漏洞
- 基于 MIME 验证的上传漏洞
- 基于目录验证的上传漏洞
- 基于服务端扩展名验证的上传漏洞
- 基于内容验证的上传漏洞

## 常见安全问题

- 上传文件是 WEB 脚本语言，服务器的 WEB 容器解释并执行了用户上传的脚本，导

  致代码执行。

- 上传文件是病毒或者木马文件，黑客用意诱骗用户或者管理员下载执行。

- 上传文件钓鱼图片或为包含了脚本的图片，在某些版本你的浏览器中会被作为脚本

  执行，被用于钓鱼和欺诈。

## 文件上传运行原理

​    上传的文件可被 WEB 服务器解析执行，并且我们上传的文件需要在可访问的地方。如
果我们通过 WEB 访问不到，或者用户上传的文件若被安全检查、格式化、图片压缩等功能
改变了内容，导致攻击不成功，也不能称之为漏洞。
![upload-1](https://github.com/bloodzer0/Enterprise_Security_Build--Open_Source/blob/master/Application%20Security/Vulnerability/img/upload-1.png)

## 解析漏洞

- IIS 5.x/6.0 解析漏洞
- IIS 7.0/IIS 7.5 解析漏洞
- Apache 解析漏洞
- Nginx <8.03 畸形解析漏洞
-  Nginx <8.03 空字节代码执行漏洞

## 设计安全的上传功能

- 文件上传的目录设置为不可执行
- 判断文件类型
- 使用随机数改写文件名和文件路径
- 单独设置文件服务器的域名

## 修复与防御

![upload-2](https://github.com/bloodzer0/Enterprise_Security_Build--Open_Source/blob/master/Application%20Security/Vulnerability/img/upload-2.png)

### 基于代码层面

- 设置黑白名单策略，例如：abcEitor编辑器中的代码片段：

```php
   if(
        (
        ($_FILES["file"]["type"] == "image/gif")
        ||
        ($_FILES["file"]["type"] == "image/jpeg")
        ||
        ($_FILES["file"]["type"] == "image/pjpeg")
        ||
        ($_FILES["file"]["type"] == "image/x-png")
        ||
        ($_FILES["file"]["type"] == "image/bmp")
        )
       ...
```

- 验证输入字符的大小写，以防大小写绕过
- 对%00 截断符进行检测，对 HTTP 包头的 content-type 也和上传文件的大小也需要进行检查。

### 基于运维层面

​    文件上传漏洞中的解析漏洞，很大一部分原因是由于应用配置不当造成的。想要避免解析漏洞，就需要做到如下几点：

- 定时查看系统日志、WEB服务器日志，查看是否有被入侵的痕迹。
- 关注第三方组件的更新情况，及时升级修补。
- 及时注意WEB应用程序的更新情况，及时打补丁，上传功能若非必须建议删除。
- 合理配置服务器的执行上传权限。上传目录建议设置为只读。

### 基于设备防护层面

- 安装基于主机的安全软件，例如：云锁、安全狗、护卫神等。
- 配置硬件防火墙或者入侵检测设备对上传的恶意脚本进行检测识别。
