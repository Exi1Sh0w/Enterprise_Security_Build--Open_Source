
> Web-Hacking ：XSS跨站脚本攻击

> ID:千域千寻

> 时间：2018/10/30

## 知识概述

### 概念

​    XSS漏洞攻击全称跨站脚本漏洞攻击( Cross-Site Scripting )，为了和层叠样式表的缩写进行区别，故将跨站脚本漏洞缩写为XSS。XSS漏洞存在于WEB应用程序中，允许用户注入恶意代码到其中并将内容反馈到页面，从而导致漏洞攻击。

### 成因

**理论层面**

- 对于用户输入没有严格控制直接输出到页面
- 对非预期输入的信任
- 对于输出没有经过过滤和编码

**代码层面**

```php+HTML
<form action="" method="get">  
<input type="text" name="xss"/>  
<input type="submit" value="test"/>  
</form>  
<?php  
$xss = @$_GET['xss'];  
if($xss!==null){  
echo $xss;  //未经过滤直接将提交的变量参数输出
    }
?>
```



### 危害

- 网络钓鱼，盗取用户账号
- 窃取用户Cookie凭证，从而获取用户隐私
- 网页挂马
- 针对用户进行信息收集（用户浏览历史、真实IP、开放端口等）
- 进行大量的客户端攻击，例如：DDOS攻击
- 提升用户权限
- 传播XSS蠕虫



## 知识拓展

### 漏洞类型

#### 反射型XSS

​    反射型XSS也被称为非持久性XSS或者参数型XSS，这种类型的XSS最为常见，主要用于将恶意脚本附加到URL，类似如下案例：

```javascript
http://example.com/index.php?a=<script>alert(1)</script>
```

 常见的攻击方式是：通过发送伪装好的链接或者电子邮件，诱使用户去访问包含了恶意脚本的URL。 其特点只在用户单击时触发，并且只能执行一次，不能持久，且伪装成本较高，危害有限。
![xss-1](https://github.com/bloodzer0/Enterprise_Security_Build--Open_Source/blob/master/Application%20Security/Vulnerability/img/xss-1.png)


#### 存储型XSS

​    存储型XSS又被称为持久型XSS，这类XSS比反射型XSS更具有威胁性，并且可以影响到WEB服务器的安全，因为注入的恶意代码会被直接存储到数据库中。通常存储型XSS存在于留言板、会员中心（个人资料、地址管理、站内短信等），订单管理处等。
![xss-2](https://github.com/bloodzer0/Enterprise_Security_Build--Open_Source/blob/master/Application%20Security/Vulnerability/img/xss-2.png)

#### DOM型XSS

​    传统类型的XSS通常是由于服务端代码导致的，而DOM型XSS是基于DOM文档对象模型的一种漏洞，是由于浏览器解析机制导致的漏洞，所以受客户端浏览器脚本代码的影响。

​    DOM型XSS的攻击方式是通过操纵DOM中的一些对象，在客户端输入包含恶意脚本的代码，假如这些脚本没有被过滤，就可能受到DOM型XSS的攻击。

​    而其执行的特点和流程与反射型XSS差不多，同样是非持久的，只能执行一次。只是导致安全问题的地方不同，一个是由服务端代码导致的，一个是基于DOM文档对象模型的漏洞。



### 漏洞区别

**反射型XSS：** 由服务端代码导致，代码非持久，附加在URL后面，只执行一次

**存储型XSS ：**由服务端代码导致，代码被存储在服务端数据库中 ，每访问一次包含恶意代码的页面就会触发XSS。

**DOM型XSS：**由客户端DOM文档对象模型导致，代码非持久，附加值URL后面，只执行一次。

| XSS Type  | Server           | Client            |
| :-------- | ---------------- | ----------------- |
| Stored    | 存储在服务器上   | Stored Client     |
| Reflected | 不存储在服务器上 | Reflected Clinent |
| DOM-Based | 不存储在服务器上 | Subset of Client  |

### 漏洞利用

**Cookie窃取：**最常见的一种XSS利用手段，通过XSS漏洞窃取客户端用户的cookie凭证。

**网络钓鱼：**XSS重定向钓鱼、HTML注入式钓鱼、XSS跨框架钓鱼、Flash钓鱼。

**会话劫持：**权限提升、获取webshell。

**信息收集：**客户端浏览器信息、系统信息、端口信息等。

### XSS绕过方式

#### 双写绕过

​    直接基于黑名单思想替换掉某些字符串，如果只是替换了一次的话，那么就双写该字符串，就可以达到绕过的目的。

#### 替换标签

​    正则表达式替换，如果用不了某个标签比如:`<script>`，那么这个时候我们就可以选择别的标签。

#### 大小写混淆

​    直接基于黑名单思想替换掉某些字符串，如果区分大小写的话，那么只要大小写绕过即可。

#### 编码绕过

​    将原本的测试语句进行编码转换，常见的有(16进制、url编码、utf-7编码等等)。

#### 基于浏览器特性绕过

​    某些浏览器的某个版本可能过滤机制不完善，存在可利用的可能，可以利用浏览器的过滤机制绕过。

## 修复建议

### 基于代码层的修复建议

- 基于黑名单，过滤敏感字符、例如：符号、标签属性、js事件等，如图示例`（*代码来源phpcms2008sp4 (phpcms\include)`
![xss-3](https://github.com/bloodzer0/Enterprise_Security_Build--Open_Source/blob/master/Application%20Security/Vulnerability/img/xss-3.png)

- 在PHP中可以通过htmlspecialchars()函数，将客户端输入内容转成HTML实体编码。

  | 显示结果 | 描述   | 实体名称 |
  | -------- | ------ | -------- |
  |          | 空格   | &nbsp ;  |
  | <        | 小于号 | &lt ;    |
  | >        | 大于号 | &gt ;    |
  | &        | 和号   | &amp ;   |
  | "        | 引号   | &quot ;  |

- 设置Cookie的HttpOnly属性

  设置Cookie的HttpOnly，有效防止Cookie通过脚本泄密（IE6sp1以上、Firefox3）。

### 基于平台层的修复建议

​    基于平台层面防御XSS，最好的就是安装一款基于主机的WAF防火墙，例如：安全狗、云锁等等，虽然存在被绕过的可能性，但是可以一定程度的提高攻击成本，遏制一部分低端的脚本攻击。
![xss-4](https://github.com/bloodzer0/Enterprise_Security_Build--Open_Source/blob/master/Application%20Security/Vulnerability/img/xss-4.png)
